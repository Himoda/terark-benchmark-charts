{% extends 'layout.html' %}

{% block content %}
<div>URL Params : engine, step(以秒为单位), duration(以小时为单位，如果输入是区间，请不要加这个参数), start(如2012-12-10 10:31:33), end(同start)</div>
<div class="selection-ctn">
    <span>引擎名称:</span>
    <!--
    <span><button class="engine blue-button" value="terarkdb">TerarkDB</button></span>
    <span><button class="engine gray-button" value="wiredtiger">WiredTiger</button></span>
    <span><button class="engine gray-button" value="rocksdb">RocksDB</button></span>
    <span><button class="engine gray-button" value="terocksdb">TerocksDB</button></span>
    -->
    {% for engine in engines %}
    <span><button class="engine gray-button" value="{{engine.engine_name}}">{{ engine.engine_name }}</button></span>
    {% endfor %}
</div>
<div class="selection-ctn">
    <span>统计间隔:</span>
    <span><button class="step gray-button" value="10">10秒</button></span>
    <span><button class="step blue-button" value="30">30秒</button></span>
    <span><button class="step gray-button" value="60">60秒</button></span>
    <span><button class="step gray-button" value="600">600秒</button></span>
    <span><button class="step gray-button" value="1800">30分钟</button></span>
    <span><button class="step gray-button" value="3600">60分钟</button></span>
</div>
<div class="selection-ctn">
    <span>统计历史:</span>
    <span><button class="duration blue-button" value="1">1小时</button></span>
    <span><button class="duration gray-button" value="3">3小时</button></span>
    <span><button class="duration gray-button" value="6">6小时</button></span>
    <span><button class="duration gray-button" value="12">12小时</button></span>
    <span><button class="duration gray-button" value="24">24小时</button></span>
    <span><button class="duration gray-button" value="72">72小时</button></span>
    <span><button class="duration gray-button" value="240">240小时</button></span>
    <span>
	    <input type="text" id="start-time" value="2016-12-05 15:10:00"/> to <input type="text" id="end-time" value="2016-12-05 00:00:00"/>
    </span>
    <span><button id="choose-time" class="gray-button" value="0">提交</button></span>
</div>

<div id="setting" class="green-button">参数设定</div>

<div id="loading">
    Loading...
</div>

<!-- 设定参数重启 -->
<div id="restart" class="hide">
    <div style="text-align: center;color:#888;">暂未实现</div>
    <div>
        <span>线程数：</span>
        <span><input type="text"/></span>
    </div>
    <div>
        <span>读比例：</span>
        <span><input type="text"/></span>
    </div>
    <div>
        <span>插入比例：</span>
        <span><input type="text"/></span>
    </div>
    <div>
        <span>更新比例：</span>
        <span><input type="text"/></span>
    </div>
    <div>
        <span>密码：</span>
        <span><input type="text"/></span>
    </div>
    <div class="buttons">
        <button id="restart-submit" class="blue-button">重启</button>
        <button id="restart-cancel" class="gray-button">取消</button>
    </div>
</div>

<div id="ops-chart" style="width: 100%;height:500px;"></div>
<div id="cpu-chart" style="width: 100%;height:500px;"></div>
<div id="memory-chart" style="width: 100%;height:500px;"></div>
<div id="dbsize-chart" style="width: 100%;height:500px;"></div>

{% endblock %}

{% block pageCSS %}
<style>
    #loading {
        font-size: 36px;
        text-align: center;
        padding: 100px;
    }

    #setting {
        width: 80px;
        top: 50px;
        position: absolute;
        right: 10px;
        height: 30px;
        line-height: 32px;
        display: none;
    }

    #restart {
        position: absolute;
        top: 50px;
        right: 100px;
        padding: 20px;
        border: 1px solid #CCC;
        background-color: #FFF;
        z-index: 1000;
    }

    #restart div > span:first-child {
        width: 80px;
        display: inline-block;
    }

    #restart .buttons {
        text-align: center;
        margin-top: 10px;
    }

    #restart button {
        width: 80px;
        height: 30px;
        line-height: 32px;
        display: inline-block;
    }
</style>
{% endblock %}

{% block pageJS %}
<script type="text/javascript" src="/asserts/javascripts/echarts.min.js"></script>
<script type="text/javascript" src="/asserts/javascripts/common.js"></script>

<script type="text/javascript">
	(function($){
		$.getUrlVar = function(key){
			var result = new RegExp(key + "=([^&]*)", "i").exec(window.location.search); 
			return result && unescape(result[1]) || ""; 
		};
	})(jQuery);

    // 切换统计间隔时间
    $(function () {
        $(".step").click(function () {
            $(".step.blue-button").addClass("gray-button")
            $(".step.blue-button").removeClass("blue-button")
            $(this).removeClass("gray-button")
            $(this).addClass("blue-button")
            reloadChart()
        })

	var step = $.getUrlVar('step')
		$('.step').each(function(i, e){
			if($(e).val() == step) {
				$(e).click()
			}
		})
    })

    // 切换统计时间区间
    $(function () {
        $(".duration").click(function () {
            $(".duration.blue-button").addClass("gray-button")
            $(".duration.blue-button").removeClass("blue-button")
            $(this).removeClass("gray-button")
            $(this).addClass("blue-button")
	    $("#choose-time").val(0)
            reloadChart()
        })

	var duration = $.getUrlVar('duration')
	$('.duration').each(function(i, e){
		if($(e).val() == duration) {
			$(e).click()
		}
	})
    })

    // 切换引擎
    $(function () {
        $(".engine").click(function () {
            $(".engine.blue-button").addClass("gray-button")
            $(".engine.blue-button").removeClass("blue-button")
            $(this).removeClass("gray-button")
            $(this).addClass("blue-button")
            reloadChart()
        })

	var engine = $.getUrlVar('engine')
	if(!!engine) {
		$(".engine").each(function(i, e){
			if($(e).text() == engine) {
				$(e).click()
			}
		})
	}
    })
    // 选择指定时间区间
    $(function () {
        $("#choose-time").click(function () {
	    var start = $("#start-time").val();
	    var end = $("#end-time").val();
	    $("#choose-time").val(start + "~" + end);
	    reloadChart();
	})
	var duration = $.getUrlVar('duration')
	var start = $.getUrlVar('start')
	var end = $.getUrlVar('end')
	if(!!start && !!end && !duration) {
		$("#start-time").val(start)
		$("#end-time").val(end)
		$("#choose-time").click()
	}

    })

    $("#setting").click(function () {
        $("#restart").show()
    })
    $("#restart-submit").click(function () {
        if (confirm("确定要用新参数重启么？")) {
            console.log("do restart")
        }
    })
    $("#restart-cancel").click(function () {
        $("#restart").hide()
    })

    // 重新加载页面内的所有折线图
    function reloadChart() {
        $("#loading").show();
        var engine = $(".engine.blue-button").attr("value")
        var step = $(".step.blue-button").attr("value")
        var duration = $(".duration.blue-button").attr("value")
	if($("#choose-time").val() != 0) {
		duration = $("#choose-time").val()
	}
	
        var opsChart = echarts.init(document.getElementById('ops-chart'));
        var cpuChart = echarts.init(document.getElementById('cpu-chart'))
        var memoryChart = echarts.init(document.getElementById('memory-chart'))
        var dbsizeChart = echarts.init(document.getElementById('dbsize-chart'))

        // 指定图表的配置项和数据
        var opsOption = {
            title: {
                text: 'OPS'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['总操作', '读操作', '写操作', '更新操作']
            },
            toolbox: {
                feature: {saveAsImage: {}}
            },
            yAxis: [
                {type: 'value'}
            ],
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                }
            ]
        };
        var cpuOption = {
            title: {
                text: 'CPU Usage'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['利用率(%)', 'iowait(%)']
            },
            toolbox: {
                feature: {saveAsImage: {}}
            },
            yAxis: [
                {type: 'value'}
            ],
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                }
            ]
        };
        // 指定图表的配置项和数据
        var memoryOption = {
            title: {
                text: 'Memory Usage(MB)'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['Total', 'Free', 'Cached', 'Used']
            },
            toolbox: {
                feature: {saveAsImage: {}}
            },
            yAxis: [
                {type: 'value'}
            ],
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                }
            ]
        };

        // 指定图表的配置项和数据
        var dbsizeOption = {
            title: {
                text: 'DB Size(MB)'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['dbsize(MB)']
            },
            toolbox: {
                feature: {saveAsImage: {}}
            },
            yAxis: [
                {type: 'value'}
            ],
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                }
            ]
        };

        function makeRequest() {
            $.ajax({
                type: "POST",
                url: "/api/engine",
                contentType: "application/json",
                async: true,
                data: JSON.stringify({
                    "engine": engine,
                    "step": step,
                    "duration": duration
                }),
                dataType: "json",
                success: function (data) {
                    $("#loading").hide();
                    // OPS
                    opsOption.xAxis = {
                        data: data['time_bucket']
                    }
                    opsOption.series = [{
                        name: '总操作',
                        type: 'line',
                        data: data['ops_total'],
                        markLine: {
                            data: [
                                {type: 'average', name: '总操作平均值'}
                            ]
                        }
                    }, {
                        name: '读操作',
                        type: 'line',
                        data: data['ops_read']
                    }, {
                        name: '写操作',
                        type: 'line',
                        data: data['ops_insert']
                    }, {
                        name: '更新操作',
                        type: 'line',
                        data: data['ops_update']
                    }]
                    opsChart.setOption(opsOption);

                    // CPU Usage
                    cpuOption.xAxis = {
                        data: data['time_bucket']
                    }
                    cpuOption.series = [{
                        name: '利用率(%)',
                        type: 'line',
                        data: data['cpu_usage']
                    }, {
                        name: 'iowait(%)',
                        type: 'line',
                        data: data['cpu_iowait']
                    }]
                    cpuChart.setOption(cpuOption);

                    // Memory Usage
                    memoryOption.xAxis = {
                        data: data['time_bucket']
                    }
                    memoryOption.series = [{
                        name: 'Total',
                        type: 'line',
                        data: data['total_memory']
                    }, {
                        name: 'Free',
                        type: 'line',
                        data: data['free_memory']
                    }, {
                        name: 'Cached',
                        type: 'line',
                        data: data['cached_memory']
                    }, {
                        name: 'Used',
                        type: 'line',
                        data: data['used_memory']
                    }]
                    memoryChart.setOption(memoryOption);

                    // DB Size/ Disk Info
                    dbsizeOption.xAxis = {
                        data: data['time_bucket']
                    }
                    dbsizeOption.tooltip = {
                        trigger: 'axis',
                        formatter: function (params) {
                            var index = params[0].dataIndex
                            var str = params[0].name + "\ndbsize(MB) : " + params[0].value + " MB\n" + data['diskinfo'][index];
                            return "<pre>" + str.replace(/\.\/experiment\/terark_wiki/g, "") + "</pre>"
                        }
                    }
                    dbsizeOption.series = [{
                        name: 'dbsize(MB)',
                        type: 'line',
                        data: data['dbsize']
                    }]
                    dbsizeChart.setOption(dbsizeOption);
                }
            })
        }

        makeRequest()
        // 间隔是一小时的时候，定期进行采样
        if (duration == 1) {
            setInterval(makeRequest, duration > 24 ? 100000 : 10000)
        }
    }
    reloadChart()


    // 单独渲染latency percentile, 不进行自动刷新
    function reloadLatencyPercentile() {
        var engine = $(".engine.blue-button").attr("value")
        var step = $(".step.blue-button").attr("value")
        var duration = $(".duration.blue-button").attr("value")
        var latencyChart = echarts.init(document.getElementById('latency-chart'));
        var latencyOption = {
            title: {
                text: 'Latency Percentile'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['Percentile']
            },
            toolbox: {
                feature: {saveAsImage: {}}
            },
            yAxis: [
                {type: 'value'}
            ],
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                }
            ]
        };
        $.ajax({
            type: "POST",
            url: "/api/engine/latency",
            contentType: "application/json",
            async: true,
            data: JSON.stringify({
                "engine": engine,
                "step": step,
                "duration": duration
            }),
            dataType: "json",
            success: function (data) {
                // OPS
                latencyOption.xAxis = {
                    data: data['operations']
                }
                latencyOption.series = [{
                    name: 'Percentile',
                    type: 'line',
                    data: data['percentile']
                }]
                latencyChart.setOption(latencyOption);
            }
        })
    }
</script>
{% endblock %}
