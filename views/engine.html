{% extends 'layout.html' %}

{% block content %}
<div class="selection-ctn">
    <span>引擎名称:</span>
    <span><button class="engine blue-button" value="terarkdb">TerarkDB</button></span>
    <span><button class="engine gray-button" value="wiredtiger">WiredTiger</button></span>
    <span><button class="engine gray-button" value="rocksdb">RocksDB</button></span>
</div>
<div class="selection-ctn">
    <span>统计间隔:</span>
    <span><button class="step blue-button" value="10">10秒</button></span>
    <!--<span><button class="step gray-button" value="30">30秒</button></span>-->
    <!--<span><button class="step gray-button" value="60">1分钟</button></span>-->
</div>
<div class="selection-ctn">
    <span>统计历史:</span>
    <span><button class="duration blue-button" value="1">1小时</button></span>
    <span><button class="duration gray-button" value="3">3小时</button></span>
    <span><button class="duration gray-button" value="12">12小时</button></span>
    <span><button class="duration gray-button" value="24">24小时</button></span>
    <span><button class="duration gray-button" value="72">72小时</button></span>
    <span><button class="duration gray-button" value="9999">所有时间</button></span>
</div>

<div id="setting" class="green-button">参数设定</div>
<div id="auto-refresh" value="0" class="green-button disabled">实时更新</div>

<div id="loading">
    Loading...
</div>

<!-- 设定参数重启 -->
<div id="restart" class="hide">
    <div style="text-align: center;color:#888;">暂未实现</div>
    <div>
        <span>线程数：</span>
        <span><input type="text"/></span>
    </div>
    <div>
        <span>读比例：</span>
        <span><input type="text"/></span>
    </div>
    <div>
        <span>插入比例：</span>
        <span><input type="text"/></span>
    </div>
    <div>
        <span>更新比例：</span>
        <span><input type="text"/></span>
    </div>
    <div>
        <span>密码：</span>
        <span><input type="text"/></span>
    </div>
    <div class="buttons">
        <button id="restart-submit" class="blue-button">重启</button>
        <button id="restart-cancel" class="gray-button">取消</button>
    </div>
</div>

<div id="ops-chart" style="width: 100%;height:500px;"></div>
<div id="cpu-chart" style="width: 100%;height:500px;"></div>
<div id="memory-chart" style="width: 100%;height:500px;"></div>

{% endblock %}

{% block pageCSS %}
<style>
    #loading {
        font-size: 36px;
        text-align: center;
        padding: 100px;
    }

    #setting {
        width: 80px;
        top: 50px;
        position: absolute;
        right: 10px;
        height: 30px;
        line-height: 32px;
        display: none;
    }

    #restart {
        position: absolute;
        top: 50px;
        right: 100px;
        padding: 20px;
        border: 1px solid #CCC;
        background-color: #FFF;
        z-index: 1000;
    }

    #restart div > span:first-child {
        width: 80px;
        display: inline-block;
    }

    #restart .buttons {
        text-align: center;
        margin-top: 10px;
    }

    #restart button {
        width: 80px;
        height: 30px;
        line-height: 32px;
        display: inline-block;
    }

    #auto-refresh {
        width: 100px;
        top: 50px;
        position: absolute;
        right: 10px;
        height: 30px;
        line-height: 32px;
    }

    .disabled {
        background-color: #CCCCCC;
        cursor: pointer !important;
    }
</style>
{% endblock %}

{% block pageJS %}
<script type="text/javascript" src="/asserts/javascripts/echarts.min.js"></script>
<script type="text/javascript" src="/asserts/javascripts/common.js"></script>

<script type="text/javascript">
    // 切换统计间隔时间
    $(function () {
        $(".step").click(function () {
            $(".step.blue-button").addClass("gray-button")
            $(".step.blue-button").removeClass("blue-button")
            $(this).removeClass("gray-button")
            $(this).addClass("blue-button")
            reloadChart()
        })
    })

    // 切换统计时间区间
    $(function () {
        $(".duration").click(function () {
            $(".duration.blue-button").addClass("gray-button")
            $(".duration.blue-button").removeClass("blue-button")
            $(this).removeClass("gray-button")
            $(this).addClass("blue-button")
            reloadChart()
        })
    })

    // 切换引擎
    $(function () {
        $(".engine").click(function () {
            $(".engine.blue-button").addClass("gray-button")
            $(".engine.blue-button").removeClass("blue-button")
            $(this).removeClass("gray-button")
            $(this).addClass("blue-button")
            reloadChart()
        })
    })

    $("#setting").click(function () {
        $("#restart").show()
    })
    $("#restart-submit").click(function () {
        if (confirm("确定要用新参数重启么？")) {
            console.log("do restart")
        }
    })
    $("#restart-cancel").click(function () {
        $("#restart").hide()
    })

    // 重新加载页面内的所有折线图
    function reloadChart() {
        $("#loading").show();
        var engine = $(".engine.blue-button").attr("value")
        var step = $(".step.blue-button").attr("value")
        var duration = $(".duration.blue-button").attr("value")

        var opsChart = echarts.init(document.getElementById('ops-chart'));
        var cpuChart = echarts.init(document.getElementById('cpu-chart'))
        var memoryChart = echarts.init(document.getElementById('memory-chart'))

        // 指定图表的配置项和数据
        var opsOption = {
            title: {
                text: 'OPS'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['总操作', '读操作', '写操作', '更新操作']
            },
            toolbox: {
                feature: {saveAsImage: {}}
            },
            yAxis: [
                {type: 'value'}
            ],
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                }
            ]
        };
        var cpuOption = {
            title: {
                text: 'CPU Usage'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['利用率(%)']
            },
            toolbox: {
                feature: {saveAsImage: {}}
            },
            yAxis: [
                {type: 'value'}
            ],
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                }
            ]
        };
        // 指定图表的配置项和数据
        var memoryOption = {
            title: {
                text: 'Memory Usage(MB)'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['Total', 'Free', 'Cached', 'Used']
            },
            toolbox: {
                feature: {saveAsImage: {}}
            },
            yAxis: [
                {type: 'value'}
            ],
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: 100
                }
            ]
        };

        function makeRequest() {
            $.ajax({
                type: "POST",
                url: "/api/engine",
                contentType: "application/json",
                async: true,
                data: JSON.stringify({
                    "engine": engine,
                    "step": step,
                    "duration": duration
                }),
                dataType: "json",
                success: function (data) {
                    $("#loading").hide();
                    // OPS
                    opsOption.xAxis = {
                        data: data['time_bucket'].map(function (current, index, array) {
                            var t = new Date(1970, 0, 1) // Epoch
                            t.setSeconds(current + 8 * 60 * 60) // 加8个小时，转换成CST
                            return t.Format("yyyy-MM-dd hh:mm:ss")
                        })
                    }
                    opsOption.series = [{
                        name: '总操作',
                        type: 'line',
                        data: data['ops_total']
                    }, {
                        name: '读操作',
                        type: 'line',
                        data: data['ops_read']
                    }, {
                        name: '写操作',
                        type: 'line',
                        data: data['ops_insert']
                    }, {
                        name: '更新操作',
                        type: 'line',
                        data: data['ops_update']
                    }]
                    opsChart.setOption(opsOption);

                    // CPU Usage
                    cpuOption.xAxis = {
                        data: data['time_bucket'].map(function (current, index, array) {
                            var t = new Date(1970, 0, 1) // Epoch
                            t.setSeconds(current + 8 * 60 * 60) // 加8个小时，转换成CST
                            return t.Format("yyyy-MM-dd hh:mm:ss")
                        })
                    }
                    cpuOption.series = [{
                        name: '利用率(%)',
                        type: 'line',
                        data: data['cpu_usage']
                    }]
                    cpuChart.setOption(cpuOption);

                    // Memory Usage
                    memoryOption.xAxis = {
                        data: data['time_bucket'].map(function (current, index, array) {
                            var t = new Date(1970, 0, 1)  // UTC
                            t.setSeconds(current + 8 * 60 * 60) // 加8个小时，转换成CST
                            return t.Format("yyyy-MM-dd hh:mm:ss")
                        })
                    }
                    memoryOption.series = [{
                        name: 'Total',
                        type: 'line',
                        data: data['total_memory']
                    }, {
                        name: 'Free',
                        type: 'line',
                        data: data['free_memory']
                    }, {
                        name: 'Cached',
                        type: 'line',
                        data: data['cached_memory']
                    }, {
                        name: 'Used',
                        type: 'line',
                        data: data['used_memory']
                    }]
                    memoryChart.setOption(memoryOption);
                }
            })
        }

        makeRequest()
        var intervalId = 0
        $("#auto-refresh").click(function () {
            var val = $(this).attr("value")
            if (val == 0) {
                $(this).attr("value", 1)
                $(this).removeClass("disabled")
                intervalId = setInterval(makeRequest, duration > 24 ? 100000 : 10000)
            } else {
                $(this).attr("value", 0)
                $(this).addClass("disabled")
                clearInterval(intervalId)
            }
        })

    }
    reloadChart()
</script>
{% endblock %}